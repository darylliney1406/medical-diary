# MediDiary

A containerised, mobile-first medical diary PWA. Log blood pressure readings, symptoms, food & drink intake, and gym sessions. Generate AI-powered daily and weekly summaries using Claude. Export doctor-ready PDFs.

---

## Architecture

```
nginx (SSL termination)
    ├── /api/  → FastAPI (Python) — port 8000
    └── /      → Vue 3 PWA (nginx) — port 80

PostgreSQL 15
```

---

## Prerequisites

- Docker & Docker Compose (v2)
- An Ubuntu server with nginx installed
- A domain name with DNS pointing to your server
- An Anthropic API key

---

## Deployment

### 1. Clone and configure

```bash
git clone <repo> medidiary
cd medidiary
cp .env.example .env
```

Edit `.env` and set:
- `POSTGRES_PASSWORD` — a strong random password
- `SECRET_KEY` — generate with: `python3 -c "import secrets; print(secrets.token_hex(32))"`
- `ANTHROPIC_API_KEY` — your Anthropic API key
- `FRONTEND_URL` — your public domain (e.g. `https://health.example.com`)

### 2. Build and start containers

```bash
docker compose up -d --build
```

This starts:
- `db` — PostgreSQL 15
- `backend` — FastAPI on port 8000
- `frontend` — Vue 3 PWA served by nginx on port 80

### 3. Run database migrations

```bash
docker compose exec backend alembic upgrade head
```

### 4. Create the first admin user

```bash
docker compose exec backend python -c "
import asyncio
from app.database import get_async_session_context
from app.services.auth import create_user

async def main():
    async with get_async_session_context() as session:
        user = await create_user(
            session,
            email='admin@example.com',
            password='changeme',
            name='Admin',
            role='admin'
        )
        print(f'Created admin: {user.email}')

asyncio.run(main())
"
```

### 5. Configure nginx reverse proxy

Copy the sample config:
```bash
sudo cp nginx.conf /etc/nginx/sites-available/medidiary
sudo ln -s /etc/nginx/sites-available/medidiary /etc/nginx/sites-enabled/
```

Edit `/etc/nginx/sites-available/medidiary` and replace `your-domain.com` with your actual domain.

**SSL with Let's Encrypt:**
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
sudo nginx -t && sudo systemctl reload nginx
```

---

## Development

### Backend

```bash
cd backend
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# Start a local postgres (or point DATABASE_URL at your Docker postgres)
export DATABASE_URL="postgresql+asyncpg://medidiary:changeme@localhost:5432/medidiary"
export SECRET_KEY="dev_secret"
export ANTHROPIC_API_KEY="sk-ant-..."
export FRONTEND_URL="http://localhost:5173"

alembic upgrade head
uvicorn app.main:app --reload --port 8000
```

API docs: http://localhost:8000/docs

### Frontend

```bash
cd frontend
npm install

# Create .env.local
echo "VITE_API_URL=http://localhost:8000/api/v1" > .env.local

npm run dev
```

App: http://localhost:5173

---

## Updates

```bash
git pull
docker compose up -d --build
docker compose exec backend alembic upgrade head
```

---

## Environment Variables

| Variable | Required | Description |
|---|---|---|
| `POSTGRES_USER` | Yes | PostgreSQL username |
| `POSTGRES_PASSWORD` | Yes | PostgreSQL password |
| `POSTGRES_DB` | Yes | PostgreSQL database name |
| `SECRET_KEY` | Yes | JWT signing key (32+ random bytes, hex) |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | No | JWT access token TTL (default: 15) |
| `REFRESH_TOKEN_EXPIRE_DAYS` | No | Refresh token TTL in days (default: 30) |
| `ANTHROPIC_API_KEY` | Yes | Anthropic API key for AI summaries |
| `FRONTEND_URL` | Yes | Frontend origin for CORS (e.g. `https://health.example.com`) |

---

## Features

- **4 entry types:** Blood pressure (up to 3 readings/session with WHO colour coding), symptom events, food & drink (with personal catalogue), gym sessions
- **5 views:** Dashboard, New Entry, Calendar, Daily Log, Weekly Summary
- **AI summaries:** Daily and weekly narratives generated by Claude, suitable for sharing with your GP
- **PDF export:** Doctor-ready exports with date ranges, BP colour coding, and AI summaries
- **PWA:** Add to home screen on Android and iOS; behaves like a native app
- **Multi-user:** Admin and user roles; strict data isolation between users
- **MFA:** Optional TOTP (Google Authenticator compatible) per user
- **Persistent sessions:** 30-day refresh tokens — no constant re-login

---

## Security Notes

- The Anthropic API key is stored server-side only and never exposed to the browser
- Refresh tokens are stored in HTTP-only, SameSite=Lax cookies
- Passwords are hashed with bcrypt
- All data is strictly scoped per user — users cannot access each other's data
- Login endpoint is rate-limited (5 requests/minute per IP)
